<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Sistema de Aportes ONG</title>

    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        /* General */
        body {
            font-family: Arial, sans-serif;
            margin: 0;
            padding: 0;
            background-color: #f4f7f6;
            color: #333;
        }

        .container {
            max-width: 1200px;
            margin: 20px auto;
            padding: 20px;
            background-color: #fff;
            box-shadow: 0 0 10px rgba(0, 0, 0, 0.1);
            border-radius: 8px;
        }

        h1, h2, h3, h4 {
            color: #0056b3;
            margin-bottom: 15px;
        }

        h1 { font-size: 2.5em; text-align: center; }
        h2 { font-size: 2em; border-bottom: 2px solid #eee; padding-bottom: 10px; margin-bottom: 20px; }

        .form-group {
            margin-bottom: 15px;
        }

        .form-group label {
            display: block;
            margin-bottom: 5px;
            font-weight: bold;
        }

        .form-group input[type="text"],
        .form-group input[type="number"],
        .form-group input[type="password"],
        .form-group input[type="date"],
        .form-group select,
        .form-group textarea {
            width: calc(100% - 22px);
            padding: 10px;
            border: 1px solid #ddd;
            border-radius: 4px;
            box-sizing: border-box;
        }

        .button {
            background-color: #007bff;
            color: white;
            padding: 10px 20px;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            font-size: 1em;
            margin-right: 10px;
            transition: background-color 0.3s ease;
        }

        .button:hover {
            background-color: #0056b3;
        }

        .button.secondary {
            background-color: #6c757d;
        }
        .button.secondary:hover {
            background-color: #5a6268;
        }

        .button.danger {
            background-color: #dc3545;
        }
        .button.danger:hover {
            background-color: #c82333;
        }

        .message {
            padding: 10px;
            margin-bottom: 15px;
            border-radius: 4px;
            display: none; /* Hidden by default */
        }

        .message.success {
            background-color: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
        }

        .message.error {
            background-color: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
        }

        .tab-buttons {
            display: flex;
            margin-bottom: 20px;
            border-bottom: 2px solid #eee;
        }

        .tab-button {
            padding: 12px 20px;
            cursor: pointer;
            background-color: #f0f0f0;
            border: 1px solid #ddd;
            border-bottom: none;
            border-radius: 5px 5px 0 0;
            margin-right: 5px;
            font-weight: bold;
            color: #555;
            transition: background-color 0.3s ease;
        }

        .tab-button.active {
            background-color: #007bff;
            color: white;
            border-color: #007bff;
            border-bottom: 2px solid #007bff;
        }

        .tab-button:hover:not(.active) {
            background-color: #e2e6ea;
        }

        .module {
            display: none; /* Hidden by default */
        }

        .module.active {
            display: block;
        }

        /* Loading Spinner */
        .loading-spinner {
            border: 4px solid rgba(0, 0, 0, 0.1);
            border-left-color: #007bff;
            border-radius: 50%;
            width: 30px;
            height: 30px;
            animation: spin 1s linear infinite;
            margin: 20px auto;
            display: none; /* Hidden by default */
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        /* Tables */
        .data-table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 20px;
        }

        .data-table th, .data-table td {
            border: 1px solid #ddd;
            padding: 8px;
            text-align: left;
        }

        .data-table th {
            background-color: #f2f2f2;
            font-weight: bold;
        }

        .data-table tbody tr:nth-child(even) {
            background-color: #f9f9f9;
        }

        .data-table tbody tr:hover {
            background-color: #eef;
        }

        /* Modal */
        .modal {
            display: none; /* Hidden by default */
            position: fixed; /* Stay in place */
            z-index: 1000; /* Sit on top */
            left: 0;
            top: 0;
            width: 100%; /* Full width */
            height: 100%; /* Full height */
            overflow: auto; /* Enable scroll if needed */
            background-color: rgba(0,0,0,0.6); /* Black w/ opacity */
            justify-content: center;
            align-items: center;
        }

        .modal-content {
            background-color: #fefefe;
            margin: auto;
            padding: 25px;
            border: 1px solid #888;
            width: 80%; /* Could be more specific */
            max-width: 900px; /* Max width */
            border-radius: 8px;
            box-shadow: 0 5px 15px rgba(0,0,0,0.3);
            position: relative;
        }

        .close-button {
            color: #aaa;
            float: right;
            font-size: 28px;
            font-weight: bold;
            position: absolute;
            top: 10px;
            right: 20px;
        }

        .close-button:hover,
        .close-button:focus {
            color: black;
            text-decoration: none;
            cursor: pointer;
        }

        /* Payment Status Grid - Mejoras de Estilo */
        .payment-status-grid-container, .public-payment-status-grid-container {
            display: grid;
            grid-template-columns: repeat(13, 1fr); /* Año + 12 meses */
            gap: 1px;
            background-color: #ccc; /* Color de las líneas de la cuadrícula */
            border: 1px solid #bbb;
            overflow-x: auto;
            max-height: 400px;
            margin-top: 15px;
            border-radius: 5px; /* Bordes ligeramente redondeados */
            box-shadow: 0 2px 5px rgba(0,0,0,0.15); /* Sombra sutil */
        }

        .payment-grid-header, .payment-grid-item {
            background-color: #fcfcfc;
            padding: 10px 5px;
            text-align: center;
            font-size: 0.9em;
            border: 1px solid #eee; /* Bordes internos más suaves */
            display: flex;
            align-items: center;
            justify-content: center;
            box-sizing: border-box;
        }

        .payment-grid-header {
            font-weight: bold;
            background-color: #e9ecef; /* Un gris más claro */
            color: #343a40;
            position: sticky;
            top: 0;
            z-index: 1;
            white-space: nowrap; /* Evita que el texto se rompa */
        }

        /* Estilos mejorados para Pagado y No Pagado */
        .paid {
            color: white;
            background-color: #28a745; /* Verde vibrante */
            font-weight: bold;
            box-shadow: inset 0 0 5px rgba(0,0,0,0.2); /* Sombra interna para profundidad */
            border-radius: 3px; /* Bordes ligeramente redondeados para las celdas */
        }

        .unpaid {
            color: white;
            background-color: #dc3545; /* Rojo vibrante */
            font-weight: bold;
            box-shadow: inset 0 0 5px rgba(0,0,0,0.2);
            border-radius: 3px;
        }

        .public-view-header {
            text-align: center;
            margin-bottom: 20px;
        }
        .public-view-header h2 {
            font-size: 2em;
            color: #007bff;
        }
        .public-view-header p {
            font-size: 1.1em;
            color: #555;
        }
    </style>
</head>
<body>
    <div id="login-module" class="container">
        <h1>Iniciar Sesión</h1>
        <form id="login-form">
            <div class="form-group">
                <label for="username">Usuario:</label>
                <input type="text" id="username" name="username" required>
            </div>
            <div class="form-group">
                <label for="password">Contraseña:</label>
                <input type="password" id="password" name="password" required>
            </div>
            <button type="submit" class="button">Entrar</button>
            <div id="login-message" class="message error"></div>
        </form>
    </div>

    <div id="main-app" class="container hidden">
        <h1 id="welcome-message">Bienvenido(a) al Sistema de Aportes</h1>
        <p>Rol: <span id="user-role"></span> - Usuario: <span id="logged-in-username"></span></p>
        <button id="logout-button" class="button secondary" style="float: right; margin-top: -50px;">Cerrar Sesión</button>

        <div id="admin-tabs" class="tab-buttons hidden">
            <button class="tab-button active" onclick="showModule('dashboard-module')">Dashboard</button>
            <button class="tab-button" onclick="showModule('register-aportes-module')">Registrar Aportes</button>
            <button class="tab-button" onclick="showModule('aportes-participantes-module')">Ver Aportes - Participantes</button>
            <button class="tab-button" onclick="showModule('manage-participants-module')">Gestionar Participantes</button>
            <button class="tab-button" onclick="showModule('manage-users-module')">Gestionar Usuarios</button>
        </div>

        <div id="dashboard-module" class="module active admin-only hidden">
            <h2>Dashboard</h2>
            <div class="loading-spinner" id="dashboard-loading"></div>
            <div id="dashboard-content">
                <div style="display: flex; justify-content: space-around; flex-wrap: wrap;">
                    <div style="width: 45%; min-width: 300px; margin-bottom: 20px;">
                        <h3>Participantes Activos por Tutora</h3>
                        <canvas id="participantsByTutoraChart"></canvas>
                    </div>
                    <div style="width: 45%; min-width: 300px; margin-bottom: 20px;">
                        <h3>Estado de Deuda de Participantes</h3>
                        <canvas id="debtStatusChart"></canvas>
                    </div>
                </div>
                <div style="margin-top: 30px;">
                    <h3>Estadísticas Generales</h3>
                    <p>Total de Participantes Activos: <strong id="total-active-participants"></strong></p>
                    <p>Total de Participantes en Deuda: <strong id="total-debt-participants"></strong></p>
                    <p>Monto Total en Deuda: <strong id="total-debt-amount"></strong></p>
                    <p>Monto Total Aportado (este año): <strong id="total-aportado-year"></strong></p>
                </div>
            </div>
        </div>

        <div id="register-aportes-module" class="module admin-only hidden">
            <h2>Registrar Aportes</h2>
            <form id="registro-aporte-form">
                <div class="form-group">
                    <label for="participante-select">Seleccionar Participante:</label>
                    <select id="participante-select" required>
                        <option value="">Cargando participantes...</option>
                    </select>
                </div>
                <div class="form-group">
                    <label for="monto-mes">Monto Mensual Base:</label>
                    <input type="number" id="monto-mes" step="0.01" value="0.00" readonly>
                </div>
                <div class="form-group">
                    <label>Meses a Registrar Pago:</label>
                    <div id="meses-checkboxes" style="display: grid; grid-template-columns: repeat(auto-fill, minmax(120px, 1fr)); gap: 10px; border: 1px solid #ddd; padding: 10px; border-radius: 5px;">
                        </div>
                </div>
                <div class="form-group">
                    <label for="fecha-registro">Fecha de Registro:</label>
                    <input type="date" id="fecha-registro" required>
                </div>
                <div class="form-group">
                    <label for="monto-total-registrado">Monto Total a Registrar (Calculado):</label>
                    <input type="number" id="monto-total-registrado" step="0.01" value="0.00" readonly>
                </div>
                <button type="submit" class="button">Registrar Aporte</button>
                <div id="register-message" class="message"></div>
            </form>
        </div>

        <div id="aportes-participantes-module" class="module">
            <h2>Gestión de Pagos por Participante</h2>
            <div id="admin-search-participants" class="admin-only hidden">
                <div class="form-group">
                    <label for="search-input">Buscar Participante (Código o Nombre):</label>
                    <input type="text" id="search-input" placeholder="Ej. A001 o Juan Pérez">
                    <button class="button secondary" onclick="loadAllParticipants()">Buscar</button>
                    <button class="button secondary" onclick="document.getElementById('search-input').value=''; loadAllParticipants();">Mostrar Todos</button>
                </div>
            </div>
            <div class="loading-spinner" id="participants-loading"></div>
            <table class="data-table" id="all-participants-table">
                <thead>
                    <tr id="all-participants-table-headers">
                        </tr>
                </thead>
                <tbody id="all-participants-table-body">
                    <tr><td colspan="8">Cargando participantes...</td></tr>
                </tbody>
            </table>
        </div>

        <div id="manage-participants-module" class="module admin-only hidden">
            <h2>Gestionar Participantes</h2>
            <button class="button" onclick="openAddEditParticipantModal()">Añadir Nuevo Participante</button>
            <div class="loading-spinner" id="admin-participants-loading"></div>
            <table class="data-table">
                <thead>
                    <tr>
                        <th>Código</th>
                        <th>Nombre</th>
                        <th>Tutora</th>
                        <th>Estado</th>
                        <th>Acciones</th>
                    </tr>
                </thead>
                <tbody id="admin-participants-table-body">
                    <tr><td colspan="5">Cargando participantes...</td></tr>
                </tbody>
            </table>
        </div>

        <div id="manage-users-module" class="module admin-only hidden">
            <h2>Gestionar Usuarios</h2>
            <button class="button" onclick="openAddEditUserModal()">Añadir Nuevo Usuario</button>
            <div class="loading-spinner" id="users-loading"></div>
            <table class="data-table">
                <thead>
                    <tr>
                        <th>Usuario</th>
                        <th>Rol</th>
                        <th>Nombre Tutora (si aplica)</th>
                        <th>Acciones</th>
                    </tr>
                </thead>
                <tbody id="users-table-body">
                    <tr><td colspan="4">Cargando usuarios...</td></tr>
                </tbody>
            </table>
        </div>
    </div>

    <div id="tutora-payment-view" class="container hidden">
        <h2>Mis Participantes</h2>
        <p>Aquí puedes ver el estado de pago de tus participantes asignados.</p>
        <div class="loading-spinner" id="tutora-participants-loading"></div>
        <table class="data-table">
            <thead>
                <tr>
                    <th>Código</th>
                    <th>Participante</th>
                    <th>Meses en Deuda</th>
                    <th>Total a Pagar (al día)</th>
                    <th>Acciones</th>
                    <th>Compartir URL</th>
                </tr>
            </thead>
            <tbody id="tutora-participantes-table-body">
                <tr><td colspan="6">Cargando participantes...</td></tr>
            </tbody>
        </table>
        <button id="tutora-logout-button" class="button secondary" style="margin-top: 20px;">Cerrar Sesión</button>
    </div>


    <div id="payment-status-modal" class="modal">
        <div class="modal-content">
            <span class="close-button" onclick="closePaymentStatusModal()">&times;</span>
            <h3 id="payment-status-title">Estado de Pagos de [Participante]</h3>
            <div id="payment-status-grid" class="payment-status-grid-container">
                </div>
            <div id="modal-loading-spinner" class="loading-spinner"></div>
            <div id="modal-message" class="message error"></div>
        </div>
    </div>

    <div id="public-participant-view" class="container hidden">
        <div class="public-view-header">
            <img src="https://i.ibb.co/kH8S3zV/Logo-sin-fondo.png" alt="Logo de la ONG" style="max-width: 150px; margin-bottom: 15px;">
            <h2>Estado de Pagos del Participante</h2>
            <p id="public-participant-name-display">Cargando...</p>
        </div>
        <div id="public-payment-status-grid" class="public-payment-status-grid-container">
            </div>
        <div class="loading-spinner" id="public-loading-spinner"></div>
        <div class="message error" id="public-error-message"></div>
        <div style="text-align: center; margin-top: 30px; font-size: 0.9em; color: #777;">
            <p>Para cualquier duda o aclaración, por favor contacte a su tutora.</p>
        </div>
    </div>

    <div id="add-edit-participant-modal" class="modal">
        <div class="modal-content">
            <span class="close-button" onclick="closeAddEditParticipantModal()">&times;</span>
            <h3 id="participant-modal-title">Añadir/Editar Participante</h3>
            <form id="participant-form">
                <input type="hidden" id="participant-id">
                <div class="form-group">
                    <label for="participant-code">Código:</label>
                    <input type="text" id="participant-code" required>
                </div>
                <div class="form-group">
                    <label for="participant-name">Nombre:</label>
                    <input type="text" id="participant-name" required>
                </div>
                <div class="form-group">
                    <label for="participant-tutora">Tutora:</label>
                    <input type="text" id="participant-tutora" list="tutoras-list" required>
                    <datalist id="tutoras-list"></datalist>
                </div>
                <div class="form-group">
                    <label for="participant-ciudadania">Ciudadanía:</label>
                    <input type="text" id="participant-ciudadania">
                </div>
                <div class="form-group">
                    <label for="participant-monto-mes">Monto a Pagar Mes:</label>
                    <input type="number" id="participant-monto-mes" step="0.01" required>
                </div>
                <div class="form-group">
                    <label for="participant-saldo-favor">Saldo a Favor:</label>
                    <input type="number" id="participant-saldo-favor" step="0.01" value="0.00">
                </div>
                <div class="form-group">
                    <label for="participant-last-paid-month">Último Mes Pago:</label>
                    <input type="text" id="participant-last-paid-month" placeholder="Ej. Enero 2024">
                </div>
                <div class="form-group">
                    <label for="participant-status">Estado:</label>
                    <select id="participant-status">
                        <option value="Activo">Activo</option>
                        <option value="Inactivo">Inactivo</option>
                    </select>
                </div>
                <div class="form-group">
                    <label for="participant-fecha-ingreso">Fecha de Ingreso:</label>
                    <input type="date" id="participant-fecha-ingreso" required>
                </div>
                <button type="submit" class="button">Guardar Participante</button>
                <div id="participant-form-message" class="message"></div>
            </form>
        </div>
    </div>

    <div id="add-edit-user-modal" class="modal">
        <div class="modal-content">
            <span class="close-button" onclick="closeAddEditUserModal()">&times;</span>
            <h3 id="user-modal-title">Añadir/Editar Usuario</h3>
            <form id="user-form">
                <input type="hidden" id="user-id">
                <div class="form-group">
                    <label for="user-username">Usuario:</label>
                    <input type="text" id="user-username" required>
                </div>
                <div class="form-group">
                    <label for="user-password">Contraseña (dejar en blanco para no cambiar):</label>
                    <input type="password" id="user-password">
                </div>
                <div class="form-group">
                    <label for="user-role-select">Rol:</label>
                    <select id="user-role-select" required onchange="toggleTutoraField()">
                        <option value="administrador">Administrador</option>
                        <option value="tutora">Tutora</option>
                    </select>
                </div>
                <div class="form-group" id="user-tutora-group" style="display: none;">
                    <label for="user-tutora-name">Nombre de Tutora (si aplica):</label>
                    <input type="text" id="user-tutora-name">
                </div>
                <button type="submit" class="button">Guardar Usuario</button>
                <div id="user-form-message" class="message"></div>
            </form>
        </div>
    </div>


    <script>
        // REPLACE WITH YOUR DEPLOYED WEB APP URL
        const APP_SCRIPT_URL = 'https://script.google.com/macros/s/AKfycbwpDK1BbSBCnx-3q8qaSdeS4DG0IEadNEty1sUARIbR1w1ZWWvfGbpaMq1tghHaB9Kk/exec'; 

        let userRole = null;
        let currentTutoraName = null; // To store the tutora's name on login

        // --- UI Element References ---
        const loginModule = document.getElementById('login-module');
        const mainApp = document.getElementById('main-app');
        const publicParticipantView = document.getElementById('public-participant-view');
        const tutoraPaymentView = document.getElementById('tutora-payment-view');

        const loginForm = document.getElementById('login-form');
        const loginMessage = document.getElementById('login-message');
        const logoutButton = document.getElementById('logout-button');
        const tutoraLogoutButton = document.getElementById('tutora-logout-button');

        const welcomeMessage = document.getElementById('welcome-message');
        const userRoleSpan = document.getElementById('user-role');
        const loggedInUsernameSpan = document.getElementById('logged-in-username');

        const adminTabs = document.getElementById('admin-tabs');

        const dashboardModule = document.getElementById('dashboard-module');
        const registerAportesModule = document.getElementById('register-aportes-module');
        const aportesParticipantesModule = document.getElementById('aportes-participantes-module');
        const manageParticipantsModule = document.getElementById('manage-participants-module');
        const manageUsersModule = document.getElementById('manage-users-module');

        const allParticipantsTableHeaders = document.getElementById('all-participants-table-headers');
        const allParticipantsTableBody = document.getElementById('all-participants-table-body');

        // Modals
        const paymentStatusModal = document.getElementById('payment-status-modal');
        const addEditParticipantModal = document.getElementById('add-edit-participant-modal');
        const addEditUserModal = document.getElementById('add-edit-user-modal');

        // --- Utility Functions ---
        function showMessage(elementId, message, type = 'success') {
            const element = document.getElementById(elementId);
            element.textContent = message;
            element.className = `message ${type}`;
            element.style.display = 'block';
        }

        function hideMessage(elementId) {
            document.getElementById(elementId).style.display = 'none';
        }

        function showLoading(elementId) {
            const spinner = document.getElementById(elementId).closest('.module, .container, body').querySelector('.loading-spinner') || document.getElementById(elementId);
            if (spinner && spinner.classList.contains('loading-spinner')) {
                spinner.style.display = 'block';
            } else if (spinner) { // Fallback if no specific spinner, show a generic one
                 const genericSpinner = document.createElement('div');
                 genericSpinner.className = 'loading-spinner';
                 genericSpinner.id = 'generic-loading-spinner';
                 document.body.appendChild(genericSpinner);
                 genericSpinner.style.display = 'block';
            }
        }

        function hideLoading(elementId) {
            const spinner = document.getElementById(elementId).closest('.module, .container, body').querySelector('.loading-spinner') || document.getElementById('generic-loading-spinner');
            if (spinner) {
                spinner.style.display = 'none';
            }
        }

        function formatDateForInput(dateString) {
            if (!dateString) return '';
            const date = new Date(dateString);
            if (isNaN(date.getTime())) return '';
            const year = date.getFullYear();
            const month = (date.getMonth() + 1).toString().padStart(2, '0');
            const day = date.getDate().toString().padStart(2, '0');
            return `${year}-${month}-${day}`;
        }

        function getCurrentDateISO() {
            const today = new Date();
            const year = today.getFullYear();
            const month = (today.getMonth() + 1).toString().padStart(2, '0');
            const day = today.getDate().toString().padStart(2, '0');
            return `${year}-${month}-${day}`;
        }

        // --- Login/Logout Logic ---
        loginForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            hideMessage('login-message');
            showLoading('login-module'); // Show loading on the login module

            const username = document.getElementById('username').value;
            const password = document.getElementById('password').value;

            try {
                const response = await google.script.run.withSuccessHandler(data => {
                    hideLoading('login-module'); // Hide loading
                    if (data.success) {
                        userRole = data.user.role;
                        currentTutoraName = data.user.tutoraName || null; // Store tutora name
                        loggedInUsernameSpan.textContent = data.user.username;
                        userRoleSpan.textContent = userRole.charAt(0).toUpperCase() + userRole.slice(1);
                        welcomeMessage.textContent = `Bienvenido(a) ${data.user.username}`;

                        loginModule.classList.add('hidden');
                        mainApp.classList.remove('hidden');

                        // Handle module visibility based on role
                        if (userRole === 'administrador') {
                            adminTabs.classList.remove('hidden');
                            document.querySelectorAll('.admin-only').forEach(el => el.classList.remove('hidden'));
                            tutoraPaymentView.classList.add('hidden'); // Hide tutora view if admin
                            showModule('dashboard-module'); // Default for admin
                            loadDashboardData();
                            loadParticipantsForRegistration(); // For admin's register tab
                            loadAdminParticipantsForEdit(); // For admin's manage participant tab
                            loadUsers(); // For admin's manage users tab
                            loadAllParticipants(); // For admin's Ver Aportes - Participantes
                        } else if (userRole === 'tutora') {
                            adminTabs.classList.add('hidden');
                            document.querySelectorAll('.admin-only').forEach(el => el.classList.add('hidden'));
                            mainApp.classList.add('hidden'); // Hide main admin app structure
                            tutoraPaymentView.classList.remove('hidden'); // Show dedicated tutora view
                            loadTutoraParticipants(); // Load only her participants
                        }
                    } else {
                        showMessage('login-message', data.message, 'error');
                    }
                }).withFailureHandler(error => {
                    hideLoading('login-module'); // Hide loading
                    console.error('Login error:', error);
                    showMessage('login-message', 'Error de conexión o credenciales inválidas.', 'error');
                }).doLogin(username, password);
            } catch (error) {
                hideLoading('login-module'); // Hide loading
                console.error('Unexpected login error:', error);
                showMessage('login-message', 'Error inesperado al intentar iniciar sesión.', 'error');
            }
        });

        function logout() {
            userRole = null;
            currentTutoraName = null;
            loginModule.classList.remove('hidden');
            mainApp.classList.add('hidden');
            tutoraPaymentView.classList.add('hidden');
            publicParticipantView.classList.add('hidden');
            document.getElementById('username').value = '';
            document.getElementById('password').value = '';
            hideMessage('login-message');
            // Reset active tab for next admin login
            document.querySelectorAll('.tab-button').forEach(btn => btn.classList.remove('active'));
            document.querySelector('.tab-button').classList.add('active'); // First tab active
        }

        logoutButton.addEventListener('click', logout);
        tutoraLogoutButton.addEventListener('click', logout); // Logout button for tutora view

        // --- Module Management ---
        function showModule(moduleId) {
            document.querySelectorAll('.module').forEach(module => {
                module.classList.remove('active');
            });
            document.getElementById(moduleId).classList.add('active');

            document.querySelectorAll('.tab-button').forEach(btn => {
                if (btn.onclick.toString().includes(`showModule('${moduleId}')`)) {
                    btn.classList.add('active');
                } else {
                    btn.classList.remove('active');
                }
            });

            // Specific module loading
            if (moduleId === 'dashboard-module') {
                loadDashboardData();
            } else if (moduleId === 'register-aportes-module') {
                loadParticipantsForRegistration();
                document.getElementById('fecha-registro').value = getCurrentDateISO();
            } else if (moduleId === 'aportes-participantes-module') {
                // This module is shared, decide what to load based on role
                if (userRole === 'administrador') {
                    document.getElementById('admin-search-participants').classList.remove('hidden');
                    loadAllParticipants(); // For admin, load all (with search)
                } else if (userRole === 'tutora') {
                    // This scenario should now be handled by tutora-payment-view directly
                    // but if it ever becomes accessible, ensure it still filters
                    document.getElementById('admin-search-participants').classList.add('hidden');
                    loadTutoraParticipants(); // For tutora, load only hers
                }
            } else if (moduleId === 'manage-participants-module') {
                loadAdminParticipantsForEdit();
                loadTutorasForParticipantForm(); // Load tutoras for the datalist
            } else if (moduleId === 'manage-users-module') {
                loadUsers();
            }
        }


        // --- Dashboard Functions (Admin Only) ---
        async function loadDashboardData() {
            showLoading('dashboard-loading');
            try {
                const response = await google.script.run.withSuccessHandler(data => {
                    hideLoading('dashboard-loading');
                    if (data.success) {
                        document.getElementById('total-active-participants').textContent = data.dashboard.totalActiveParticipants;
                        document.getElementById('total-debt-participants').textContent = data.dashboard.totalParticipantsInDebt;
                        document.getElementById('total-debt-amount').textContent = `$${data.dashboard.totalDebtAmount.toFixed(2)}`;
                        document.getElementById('total-aportado-year').textContent = `$${data.dashboard.totalAportadoThisYear.toFixed(2)}`;
                        
                        updateParticipantsByTutoraChart(data.dashboard.participantsByTutora);
                        updateDebtStatusChart(data.dashboard.debtStatus);
                    } else {
                        showMessage('dashboard-loading', `Error al cargar dashboard: ${data.message}`, 'error');
                    }
                }).withFailureHandler(error => {
                    hideLoading('dashboard-loading');
                    console.error('Error al cargar dashboard:', error);
                    showMessage('dashboard-loading', 'Error de conexión al cargar el dashboard.', 'error');
                }).getDashboardData();
            } catch (error) {
                hideLoading('dashboard-loading');
                console.error('Unexpected error in loadDashboardData:', error);
                showMessage('dashboard-loading', 'Error inesperado al cargar el dashboard.', 'error');
            }
        }

        let participantsByTutoraChart;
        function updateParticipantsByTutoraChart(data) {
            const ctx = document.getElementById('participantsByTutoraChart').getContext('2d');
            const labels = data.map(item => item.tutora || 'Sin Asignar');
            const counts = data.map(item => item.count);

            if (participantsByTutoraChart) {
                participantsByTutoraChart.destroy();
            }
            participantsByTutoraChart = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: labels,
                    datasets: [{
                        label: 'Número de Participantes',
                        data: counts,
                        backgroundColor: 'rgba(0, 123, 255, 0.7)',
                        borderColor: 'rgba(0, 123, 255, 1)',
                        borderWidth: 1
                    }]
                },
                options: {
                    responsive: true,
                    scales: {
                        y: {
                            beginAtZero: true,
                            ticks: {
                                precision: 0
                            }
                        }
                    },
                    plugins: {
                        legend: {
                            display: false
                        }
                    }
                }
            });
        }

        let debtStatusChart;
        function updateDebtStatusChart(data) {
            const ctx = document.getElementById('debtStatusChart').getContext('2d');
            const labels = ['Al Día', 'En Deuda'];
            const counts = [data.alDia, data.enDeuda];

            if (debtStatusChart) {
                debtStatusChart.destroy();
            }
            debtStatusChart = new Chart(ctx, {
                type: 'pie',
                data: {
                    labels: labels,
                    datasets: [{
                        label: 'Estado de Deuda',
                        data: counts,
                        backgroundColor: ['#28a745', '#dc3545'], // Green for al día, Red for en deuda
                        hoverOffset: 4
                    }]
                },
                options: {
                    responsive: true,
                    plugins: {
                        legend: {
                            position: 'top',
                        }
                    }
                }
            });
        }


        // --- Register Aportes Functions (Admin Only) ---
        const participanteSelect = document.getElementById('participante-select');
        const mesesCheckboxes = document.getElementById('meses-checkboxes');
        const montoMesInput = document.getElementById('monto-mes');
        const montoTotalRegistradoInput = document.getElementById('monto-total-registrado');
        const registroAporteForm = document.getElementById('registro-aporte-form');

        async function loadParticipantsForRegistration() {
            showLoading('participante-select');
            try {
                const response = await google.script.run.withSuccessHandler(data => {
                    hideLoading('participante-select');
                    participanteSelect.innerHTML = '<option value="">Selecciona un participante</option>';
                    if (data.success && data.participants.length > 0) {
                        data.participants.forEach(p => {
                            const option = document.createElement('option');
                            option.value = p.ID;
                            option.textContent = `${p.Nombre} (Código: ${p.Código})`;
                            participanteSelect.appendChild(option);
                        });
                    } else {
                        participanteSelect.innerHTML = '<option value="">No se encontraron participantes.</option>';
                    }
                }).withFailureHandler(error => {
                    hideLoading('participante-select');
                    console.error('Error al cargar participantes para registro:', error);
                    participanteSelect.innerHTML = '<option value="">Error al cargar participantes.</option>';
                }).getAllParticipants(); // Admin gets all participants
            } catch (error) {
                hideLoading('participante-select');
                console.error('Unexpected error in loadParticipantsForRegistration:', error);
                participanteSelect.innerHTML = '<option value="">Error inesperado.</option>';
            }
        }

        participanteSelect.addEventListener('change', async () => {
            const participantId = participanteSelect.value;
            mesesCheckboxes.innerHTML = ''; // Clear previous months
            montoMesInput.value = '0.00';
            montoTotalRegistradoInput.value = '0.00';
            hideMessage('register-message');

            if (!participantId) return;

            showLoading('meses-checkboxes');
            try {
                const response = await google.script.run.withSuccessHandler(data => {
                    hideLoading('meses-checkboxes');
                    if (data.success && data.details) {
                        montoMesInput.value = data.details.MontoAPagarMes.toFixed(2);
                        const lastPaidDate = data.details.UltimoMesPago ? new Date(data.details.UltimoMesPago + ' 1, 00:00:00') : null;
                        
                        const currentDate = new Date();
                        let startDate = lastPaidDate ? new Date(lastPaidDate.getFullYear(), lastPaidDate.getMonth() + 1, 1) : new Date(new Date(data.details.FechaDeIngreso).getFullYear(), new Date(data.details.FechaDeIngreso).getMonth(), 1);

                        // Ensure startDate is not in the future beyond current month
                        if (startDate.getFullYear() > currentDate.getFullYear() || 
                           (startDate.getFullYear() === currentDate.getFullYear() && startDate.getMonth() > currentDate.getMonth())) {
                            startDate = new Date(currentDate.getFullYear(), currentDate.getMonth(), 1);
                        }


                        const months = ["Enero", "Febrero", "Marzo", "Abril", "Mayo", "Junio", "Julio", "Agosto", "Septiembre", "Octubre", "Noviembre", "Diciembre"];
                        let tempDate = new Date(startDate);
                        let i = 0;
                        while ((tempDate.getFullYear() < currentDate.getFullYear() || (tempDate.getFullYear() === currentDate.getFullYear() && tempDate.getMonth() <= currentDate.getMonth())) && i < 36) { // Limit to 3 years max
                            const monthName = months[tempDate.getMonth()];
                            const year = tempDate.getFullYear();
                            const monthValue = `${monthName} ${year}`;

                            const checkboxDiv = document.createElement('div');
                            const checkbox = document.createElement('input');
                            checkbox.type = 'checkbox';
                            checkbox.id = `month-${monthName}-${year}`;
                            checkbox.value = monthValue;
                            checkbox.dataset.year = year; // Store year for sorting/grouping if needed
                            checkbox.dataset.month = tempDate.getMonth(); // Store month index

                            const label = document.createElement('label');
                            label.htmlFor = `month-${monthName}-${year}`;
                            label.textContent = monthValue;

                            checkboxDiv.appendChild(checkbox);
                            checkboxDiv.appendChild(label);
                            mesesCheckboxes.appendChild(checkboxDiv);

                            tempDate.setMonth(tempDate.getMonth() + 1);
                            i++;
                        }
                        mesesCheckboxes.querySelectorAll('input[type="checkbox"]').forEach(cb => {
                            cb.addEventListener('change', calculateTotalMonto);
                        });
                        calculateTotalMonto(); // Initial calculation
                    } else {
                        mesesCheckboxes.innerHTML = '<p>No se pudieron cargar los detalles del participante.</p>';
                    }
                }).withFailureHandler(error => {
                    hideLoading('meses-checkboxes');
                    console.error('Error al cargar detalles del participante:', error);
                    mesesCheckboxes.innerHTML = '<p>Error al cargar meses para el participante.</p>';
                }).getParticipantDetails(participantId);
            } catch (error) {
                hideLoading('meses-checkboxes');
                console.error('Unexpected error in participant select change:', error);
                mesesCheckboxes.innerHTML = '<p>Error inesperado al cargar meses.</p>';
            }
        });

        function calculateTotalMonto() {
            const montoPerMonth = parseFloat(montoMesInput.value);
            let totalSelectedMonths = 0;
            mesesCheckboxes.querySelectorAll('input[type="checkbox"]:checked').forEach(() => {
                totalSelectedMonths++;
            });
            montoTotalRegistradoInput.value = (totalSelectedMonths * montoPerMonth).toFixed(2);
        }

        registroAporteForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            hideMessage('register-message');
            showLoading('registro-aporte-form');

            const participantId = participanteSelect.value;
            const selectedMonthsData = Array.from(mesesCheckboxes.querySelectorAll('input[type="checkbox"]:checked'))
                                         .map(cb => cb.value);
            const montoPerMonthBase = parseFloat(montoMesInput.value);
            const montoTotalRegistered = parseFloat(montoTotalRegistradoInput.value);
            const fechaRegistro = document.getElementById('fecha-registro').value;
            const registeredBy = loggedInUsernameSpan.textContent;

            if (!participantId || selectedMonthsData.length === 0 || isNaN(montoPerMonthBase) || isNaN(montoTotalRegistered) || !fechaRegistro) {
                showMessage('register-message', 'Por favor, completa todos los campos requeridos y selecciona al menos un mes.', 'error');
                hideLoading('registro-aporte-form');
                return;
            }

            try {
                const response = await fetch(`${APP_SCRIPT_URL}`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/x-www-form-urlencoded',
                    },
                    body: new URLSearchParams({
                        action: 'registerAporte',
                        participantId: participantId,
                        selectedMonthsData: JSON.stringify(selectedMonthsData), // Stringify the array
                        montoPerMonthBase: montoPerMonthBase,
                        montoTotalRegistered: montoTotalRegistered,
                        fechaRegistro: fechaRegistro,
                        registeredBy: registeredBy
                    }).toString()
                });
                const data = await response.json();

                if (data.success) {
                    showMessage('register-message', data.message, 'success');
                    registroAporteForm.reset();
                    mesesCheckboxes.innerHTML = '';
                    montoMesInput.value = '0.00';
                    montoTotalRegistradoInput.value = '0.00';
                    document.getElementById('fecha-registro').value = getCurrentDateISO();
                    loadParticipantsForRegistration(); // Reload participant list to reflect changes
                    loadDashboardData(); // Update dashboard
                    loadAllParticipants(); // Update main participant table
                } else {
                    showMessage('register-message', `Error al registrar aporte: ${data.message}`, 'error');
                }
            } catch (error) {
                console.error("Error al registrar aporte:", error);
                showMessage('register-message', 'Error de conexión al servidor al intentar registrar el aporte.', 'error');
            } finally {
                hideLoading('registro-aporte-form');
            }
        });

        // --- View Aportes - Participants (Admin & Tutora) ---
        const searchInput = document.getElementById('search-input');

        async function loadAllParticipants() {
            showLoading('participants-loading');
            const searchFilter = searchInput.value;
            // Admin always requests all, then filters if needed
            const tutoraFilter = userRole === 'tutora' ? currentTutoraName : ''; 

            try {
                const response = await google.script.run.withSuccessHandler(data => {
                    hideLoading('participants-loading');
                    allParticipantsTableBody.innerHTML = '';
                    
                    // Set dynamic headers
                    if (userRole === 'administrador') {
                        allParticipantsTableHeaders.innerHTML = `
                            <th>Código</th>
                            <th>Participante</th>
                            <th>Tutora</th>
                            <th>Ciudadanía</th>
                            <th>Último Mes Pago</th>
                            <th>Meses en Deuda</th>
                            <th>Total a Pagar (al día)</th>
                            <th>Acciones</th>
                            <th>Compartir URL</th>
                        `;
                    } else if (userRole === 'tutora') {
                         allParticipantsTableHeaders.innerHTML = `
                            <th>Código</th>
                            <th>Participante</th>
                            <th>Meses en Deuda</th>
                            <th>Total a Pagar (al día)</th>
                            <th>Acciones</th>
                            <th>Compartir URL</th>
                        `;
                    }

                    if (data.success && data.participants.length > 0) {
                        data.participants.forEach(p => {
                            const row = allParticipantsTableBody.insertRow();
                            row.insertCell(0).textContent = p.Código;
                            row.insertCell(1).textContent = p.Nombre;
                            
                            if (userRole === 'administrador') {
                                row.insertCell(2).textContent = p.Tutora;
                                row.insertCell(3).textContent = p.Ciudadanía;
                                row.insertCell(4).textContent = p.UltimoMesPago;
                                row.insertCell(5).textContent = p.MesesEnDeuda;
                                row.insertCell(6).textContent = `$${p.TotalAPagar.toFixed(2)}`;
                                const actionsCell = row.insertCell(7);
                                const shareCell = row.insertCell(8);

                                const viewButton = document.createElement('button');
                                viewButton.textContent = 'Ver Pagos';
                                viewButton.className = 'button secondary';
                                viewButton.onclick = () => openPaymentStatusModal(p.ID, p.Nombre);
                                actionsCell.appendChild(viewButton);

                                const shareButton = document.createElement('button');
                                shareButton.textContent = 'Compartir URL';
                                shareButton.className = 'button secondary';
                                shareButton.onclick = () => generateAndSharePublicUrl(p.ID);
                                shareCell.appendChild(shareButton);

                            } else if (userRole === 'tutora') {
                                // This section is now technically handled by loadTutoraParticipants()
                                // but if this module were ever to be re-used for tutors directly
                                // it would follow this simplified structure.
                                row.insertCell(2).textContent = p.MesesEnDeuda; // Meses en Deuda
                                row.insertCell(3).textContent = `$${p.TotalAPagar.toFixed(2)}`; // Total a Pagar (lo que debe)
                                const actionsCell = row.insertCell(4);
                                const shareCell = row.insertCell(5);

                                const viewButton = document.createElement('button');
                                viewButton.textContent = 'Ver Pagos';
                                viewButton.className = 'button secondary';
                                viewButton.onclick = () => openPaymentStatusModal(p.ID, p.Nombre);
                                actionsCell.appendChild(viewButton);

                                const shareButton = document.createElement('button');
                                shareButton.textContent = 'Compartir URL';
                                shareButton.className = 'button secondary';
                                shareButton.onclick = () => generateAndSharePublicUrl(p.ID);
                                shareCell.appendChild(shareButton);
                            }
                        });
                    } else {
                        allParticipantsTableBody.innerHTML = `<tr><td colspan="${userRole === 'administrador' ? 9 : 6}">No se encontraron participantes.</td></tr>`;
                    }
                }).withFailureHandler(error => {
                    hideLoading('participants-loading');
                    console.error('Error al cargar participantes:', error);
                    allParticipantsTableBody.innerHTML = `<tr><td colspan="${userRole === 'administrador' ? 9 : 6}" class="message error">Error al cargar participantes: ${error.message}</td></tr>`;
                }).getAllParticipants(tutoraFilter, searchFilter);
            } catch (error) {
                hideLoading('participants-loading');
                console.error('Unexpected error in loadAllParticipants:', error);
                allParticipantsTableBody.innerHTML = `<tr><td colspan="${userRole === 'administrador' ? 9 : 6}" class="message error">Error inesperado: ${error.message}</td></tr>`;
            }
        }

        searchInput.addEventListener('input', () => {
            // Optional: Auto-search on input, or wait for button click
            // For now, it's triggered by the button click to avoid too many requests
        });


        // --- Tutora Specific Participant View ---
        async function loadTutoraParticipants() {
            showLoading('tutora-participants-loading');
            try {
                // Pass currentTutoraName directly to filter in the backend
                const response = await google.script.run.withSuccessHandler(data => {
                    hideLoading('tutora-participants-loading');
                    const tableBody = document.getElementById('tutora-participantes-table-body');
                    tableBody.innerHTML = '';
                    if (data.success && data.participants.length > 0) {
                        data.participants.forEach(p => {
                            const row = tableBody.insertRow();
                            row.insertCell(0).textContent = p.Código;
                            row.insertCell(1).textContent = p.Nombre;
                            row.insertCell(2).textContent = p.MesesEnDeuda;
                            row.insertCell(3).textContent = `$${p.TotalAPagar.toFixed(2)}`;

                            const actionsCell = row.insertCell(4);
                            const viewButton = document.createElement('button');
                            viewButton.textContent = 'Ver Pagos';
                            viewButton.className = 'button secondary';
                            viewButton.onclick = () => openPaymentStatusModal(p.ID, p.Nombre);
                            actionsCell.appendChild(viewButton);

                            const shareCell = row.insertCell(5);
                            const shareButton = document.createElement('button');
                            shareButton.textContent = 'Compartir URL';
                            shareButton.className = 'button secondary';
                            shareButton.onclick = () => generateAndSharePublicUrl(p.ID);
                            shareCell.appendChild(shareButton);
                        });
                    } else {
                        tableBody.innerHTML = '<tr><td colspan="6">No se encontraron participantes asociados a tu nombre de tutora.</td></tr>';
                    }
                }).withFailureHandler(error => {
                    hideLoading('tutora-participants-loading');
                    console.error('Error al cargar participantes de tutora:', error);
                    document.getElementById('tutora-participantes-table-body').innerHTML = `<tr><td colspan="6" class="message error">Error al cargar participantes: ${error.message}</td></tr>`;
                }).getAllParticipants(currentTutoraName, ''); // Pass tutoraName and empty search filter
            } catch (error) {
                console.error('Error en loadTutoraParticipants:', error);
                document.getElementById('tutora-participantes-table-body').innerHTML = `<tr><td colspan="6" class="message error">Error inesperado: ${error.message}</td></tr>`;
            }
        }


        // --- Payment Status Modal ---
        function openPaymentStatusModal(participantId, participantName) {
            document.getElementById('payment-status-title').textContent = `Estado de Pagos de ${participantName}`;
            document.getElementById('payment-status-grid').innerHTML = ''; // Clear previous content
            paymentStatusModal.style.display = 'flex'; // Use flex for centering
            loadPaymentStatus(participantId, 'payment-status-grid', 'modal-loading-spinner', 'modal-message');
        }

        function closePaymentStatusModal() {
            paymentStatusModal.style.display = 'none';
        }

        async function loadPaymentStatus(participantId, gridElementId, loadingElementId, messageElementId) {
            showLoading(loadingElementId);
            hideMessage(messageElementId);
            try {
                const response = await google.script.run.withSuccessHandler(data => {
                    hideLoading(loadingElementId);
                    if (data.success && data.paymentStatus) {
                        displayPaymentStatusGrid(data.paymentStatus, gridElementId);
                    } else {
                        showMessage(messageElementId, `Error: ${data.message || 'No se pudo cargar el estado de pagos.'}`, 'error');
                    }
                }).withFailureHandler(error => {
                    hideLoading(loadingElementId);
                    console.error('Error loading payment status:', error);
                    showMessage(messageElementId, `Error de conexión: ${error.message}`, 'error');
                }).getPaymentStatus(participantId);
            } catch (error) {
                hideLoading(loadingElementId);
                console.error('Unexpected error in loadPaymentStatus:', error);
                showMessage(messageElementId, `Error inesperado: ${error.message}`, 'error');
            }
        }

        function displayPaymentStatusGrid(paymentStatus, gridElementId) {
            const gridContainer = document.getElementById(gridElementId);
            gridContainer.innerHTML = ''; // Clear previous content

            const years = Object.keys(paymentStatus).sort(); // Sort years
            const months = ["Enero", "Febrero", "Marzo", "Abril", "Mayo", "Junio", "Julio", "Agosto", "Septiembre", "Octubre", "Noviembre", "Diciembre"];

            // Add header row
            const yearHeader = document.createElement('div');
            yearHeader.className = 'payment-grid-header';
            yearHeader.textContent = 'Año';
            gridContainer.appendChild(yearHeader);

            months.forEach(month => {
                const monthHeader = document.createElement('div');
                monthHeader.className = 'payment-grid-header';
                monthHeader.textContent = month.substring(0, 3); // Abbreviated month
                gridContainer.appendChild(monthHeader);
            });

            // Add data rows
            years.forEach(year => {
                const yearCell = document.createElement('div');
                yearCell.className = 'payment-grid-item payment-grid-header'; // Use header style for year cell
                yearCell.textContent = year;
                gridContainer.appendChild(yearCell);

                months.forEach((month, index) => {
                    const monthKey = `${month} ${year}`;
                    const isPaid = paymentStatus[year] && paymentStatus[year][monthKey]; // Check if month exists and is paid
                    
                    const cell = document.createElement('div');
                    cell.className = 'payment-grid-item';
                    if (isPaid) {
                        cell.textContent = '✓'; // Green checkmark
                        cell.classList.add('paid');
                    } else {
                        cell.textContent = '✗'; // Red X
                        cell.classList.add('unpaid');
                    }
                    gridContainer.appendChild(cell);
                });
            });
        }


        // --- Public Participant View ---
        async function loadPublicParticipantData(participantId) {
            showLoading('public-loading-spinner');
            document.getElementById('public-participant-name-display').textContent = 'Cargando...';
            document.getElementById('public-payment-status-grid').innerHTML = ''; // Clear grid
            hideMessage('public-error-message');

            try {
                const response = await google.script.run.withSuccessHandler(data => {
                    hideLoading('public-loading-spinner');
                    if (data.success && data.details && data.paymentStatus) {
                        document.getElementById('public-participant-name-display').textContent = `Participante: ${data.details.Nombre}`;
                        displayPaymentStatusGrid(data.paymentStatus, 'public-payment-status-grid');
                    } else {
                        showMessage('public-error-message', data.message || 'No se encontró el participante o su estado de pagos.', 'error');
                        document.getElementById('public-participant-name-display').textContent = 'Error al cargar datos.';
                    }
                }).withFailureHandler(error => {
                    hideLoading('public-loading-spinner');
                    console.error('Error loading public data:', error);
                    showMessage('public-error-message', `Error de conexión: ${error.message}`, 'error');
                }).getPublicParticipantDetailsAndStatus(participantId);
            } catch (error) {
                hideLoading('public-loading-spinner');
                console.error('Unexpected error in loadPublicParticipantData:', error);
                showMessage('public-error-message', `Error inesperado: ${error.message}`, 'error');
            }
        }

        function generateAndSharePublicUrl(participantId) {
            const publicUrl = `${window.location.origin}${window.location.pathname}?action=getPublicParticipantData&id=${participantId}`;
            navigator.clipboard.writeText(publicUrl).then(() => {
                alert('URL pública copiada al portapapeles: ' + publicUrl);
            }).catch(err => {
                console.error('Error al copiar la URL: ', err);
                alert('No se pudo copiar la URL al portapapeles. Por favor, cópiala manualmente: ' + publicUrl);
            });
        }

        // --- Manage Participants Functions (Admin Only) ---
        const participantForm = document.getElementById('participant-form');
        const participantIdInput = document.getElementById('participant-id');
        const participantCodeInput = document.getElementById('participant-code');
        const participantNameInput = document.getElementById('participant-name');
        const participantTutoraInput = document.getElementById('participant-tutora');
        const participantCiudadaniaInput = document.getElementById('participant-ciudadania');
        const participantMontoMesInput = document.getElementById('participant-monto-mes');
        const participantSaldoFavorInput = document.getElementById('participant-saldo-favor');
        const participantLastPaidMonthInput = document.getElementById('participant-last-paid-month');
        const participantStatusSelect = document.getElementById('participant-status');
        const participantFechaIngresoInput = document.getElementById('participant-fecha-ingreso');
        const participantFormMessage = document.getElementById('participant-form-message');
        const tutorasDatalist = document.getElementById('tutoras-list');

        async function loadAdminParticipantsForEdit() {
            showLoading('admin-participants-loading');
            try {
                const response = await google.script.run.withSuccessHandler(data => {
                    hideLoading('admin-participants-loading');
                    const tableBody = document.getElementById('admin-participants-table-body');
                    tableBody.innerHTML = '';
                    if (data.success && data.participants.length > 0) {
                        data.participants.forEach(p => {
                            const row = tableBody.insertRow();
                            row.insertCell(0).textContent = p.Código;
                            row.insertCell(1).textContent = p.Nombre;
                            row.insertCell(2).textContent = p.Tutora;
                            row.insertCell(3).textContent = p.Estado;
                            const actionsCell = row.insertCell(4);

                            const editButton = document.createElement('button');
                            editButton.textContent = 'Editar';
                            editButton.className = 'button secondary';
                            editButton.onclick = () => openAddEditParticipantModal(p);
                            actionsCell.appendChild(editButton);

                            const deleteButton = document.createElement('button');
                            deleteButton.textContent = 'Eliminar';
                            deleteButton.className = 'button danger';
                            deleteButton.onclick = () => deleteParticipant(p.ID, p.Nombre);
                            actionsCell.appendChild(deleteButton);
                        });
                    } else {
                        tableBody.innerHTML = '<tr><td colspan="5">No se encontraron participantes.</td></tr>';
                    }
                }).withFailureHandler(error => {
                    hideLoading('admin-participants-loading');
                    console.error('Error al cargar participantes para edición:', error);
                    document.getElementById('admin-participants-table-body').innerHTML = `<tr><td colspan="5" class="message error">Error al cargar participantes: ${error.message}</td></tr>`;
                }).getAllParticipants(); // Admin gets all participants
            } catch (error) {
                hideLoading('admin-participants-loading');
                console.error('Unexpected error in loadAdminParticipantsForEdit:', error);
                document.getElementById('admin-participants-table-body').innerHTML = `<tr><td colspan="5" class="message error">Error inesperado: ${error.message}</td></tr>`;
            }
        }

        async function loadTutorasForParticipantForm() {
            try {
                const response = await google.script.run.withSuccessHandler(data => {
                    tutorasDatalist.innerHTML = '';
                    if (data.success && data.users.length > 0) {
                        data.users.filter(u => u.role === 'tutora' && u.tutoraName).forEach(tutora => {
                            const option = document.createElement('option');
                            option.value = tutora.tutoraName;
                            tutorasDatalist.appendChild(option);
                        });
                    }
                }).withFailureHandler(error => {
                    console.error('Error al cargar tutoras:', error);
                }).getAllUsers();
            } catch (error) {
                console.error('Unexpected error in loadTutorasForParticipantForm:', error);
            }
        }


        function openAddEditParticipantModal(participant = null) {
            hideMessage('participant-form-message');
            participantForm.reset();
            if (participant) {
                document.getElementById('participant-modal-title').textContent = 'Editar Participante';
                participantIdInput.value = participant.ID;
                participantCodeInput.value = participant.Código;
                participantNameInput.value = participant.Nombre;
                participantTutoraInput.value = participant.Tutora;
                participantCiudadaniaInput.value = participant.Ciudadanía;
                participantMontoMesInput.value = participant.MontoAPagarMes;
                participantSaldoFavorInput.value = participant.SaldoAFavor;
                participantLastPaidMonthInput.value = participant.UltimoMesPago; // "Mes Año" string
                participantStatusSelect.value = participant.Estado;
                participantFechaIngresoInput.value = formatDateForInput(participant.FechaDeIngreso);
            } else {
                document.getElementById('participant-modal-title').textContent = 'Añadir Nuevo Participante';
                participantIdInput.value = '';
                participantStatusSelect.value = 'Activo';
                participantFechaIngresoInput.value = getCurrentDateISO();
            }
            addEditParticipantModal.style.display = 'flex';
        }

        function closeAddEditParticipantModal() {
            addEditParticipantModal.style.display = 'none';
        }

        participantForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            hideMessage('participant-form-message');
            showLoading('add-edit-participant-modal');

            const participantData = {
                ID: participantIdInput.value || generateUniqueId(), // Use existing ID or generate new
                Código: participantCodeInput.value,
                Nombre: participantNameInput.value,
                Tutora: participantTutoraInput.value,
                Ciudadanía: participantCiudadaniaInput.value,
                MontoAPagarMes: parseFloat(participantMontoMesInput.value),
                SaldoAFavor: parseFloat(participantSaldoFavorInput.value),
                UltimoMesPago: participantLastPaidMonthInput.value,
                Estado: participantStatusSelect.value,
                FechaDeIngreso: participantFechaIngresoInput.value
            };

            try {
                const response = await fetch(`${APP_SCRIPT_URL}`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/x-www-form-urlencoded',
                    },
                    body: new URLSearchParams({
                        action: 'addOrUpdateParticipant',
                        participantData: JSON.stringify(participantData)
                    }).toString()
                });
                const data = await response.json();

                if (data.success) {
                    showMessage('participant-form-message', data.message, 'success');
                    closeAddEditParticipantModal();
                    loadAdminParticipantsForEdit(); // Recargar la tabla de gestión
                    loadAllParticipants(); // Recargar tabla de aportes
                    loadParticipantsForRegistration(); // Recargar select de registro de aportes
                    loadDashboardData(); // Actualizar dashboard
                } else {
                    showMessage('participant-form-message', `Error: ${data.message}`, 'error');
                }
            } catch (error) {
                console.error("Error al guardar participante:", error);
                showMessage('participant-form-message', 'Error de conexión al servidor.', 'error');
            } finally {
                hideLoading('add-edit-participant-modal');
            }
        });

        async function deleteParticipant(participantId, participantName) {
            if (!confirm(`¿Estás seguro de que quieres eliminar a ${participantName}? Esta acción es irreversible y también eliminará sus aportes relacionados.`)) {
                return;
            }

            try {
                const response = await fetch(`${APP_SCRIPT_URL}`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/x-www-form-urlencoded',
                    },
                    body: new URLSearchParams({
                        action: 'deleteParticipant',
                        participantId: participantId
                    }).toString()
                });
                const data = await response.json();

                if (data.success) {
                    alert(data.message);
                    loadAdminParticipantsForEdit();
                    loadAllParticipants();
                    loadParticipantsForRegistration();
                    loadDashboardData();
                } else {
                    alert(`Error al eliminar participante: ${data.message}`);
                }
            } catch (error) {
                console.error("Error al eliminar participante:", error);
                alert('Error de conexión al servidor al intentar eliminar el participante.');
            }
        }

        function generateUniqueId() {
            return 'xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx'.replace(/[xy]/g, function(c) {
                var r = Math.random() * 16 | 0, v = c == 'x' ? r : (r & 0x3 | 0x8);
                return v.toString(16);
            });
        }


        // --- Manage Users Functions (Admin Only) ---
        const userForm = document.getElementById('user-form');
        const userIdInput = document.getElementById('user-id');
        const userUsernameInput = document.getElementById('user-username');
        const userPasswordInput = document.getElementById('user-password');
        const userRoleSelect = document.getElementById('user-role-select');
        const userTutoraGroup = document.getElementById('user-tutora-group');
        const userTutoraNameInput = document.getElementById('user-tutora-name');
        const userFormMessage = document.getElementById('user-form-message');

        function toggleTutoraField() {
            if (userRoleSelect.value === 'tutora') {
                userTutoraGroup.style.display = 'block';
                userTutoraNameInput.setAttribute('required', 'required');
            } else {
                userTutoraGroup.style.display = 'none';
                userTutoraNameInput.removeAttribute('required');
                userTutoraNameInput.value = ''; // Clear tutora name if not a tutora
            }
        }

        async function loadUsers() {
            showLoading('users-loading');
            try {
                const response = await google.script.run.withSuccessHandler(data => {
                    hideLoading('users-loading');
                    const tableBody = document.getElementById('users-table-body');
                    tableBody.innerHTML = '';
                    if (data.success && data.users.length > 0) {
                        data.users.forEach(user => {
                            const row = tableBody.insertRow();
                            row.insertCell(0).textContent = user.username;
                            row.insertCell(1).textContent = user.role;
                            row.insertCell(2).textContent = user.tutoraName || 'N/A';
                            const actionsCell = row.insertCell(3);

                            const editButton = document.createElement('button');
                            editButton.textContent = 'Editar';
                            editButton.className = 'button secondary';
                            editButton.onclick = () => openAddEditUserModal(user);
                            actionsCell.appendChild(editButton);

                            const deleteButton = document.createElement('button');
                            deleteButton.textContent = 'Eliminar';
                            deleteButton.className = 'button danger';
                            deleteButton.onclick = () => deleteUser(user.ID, user.username);
                            actionsCell.appendChild(deleteButton);
                        });
                    } else {
                        tableBody.innerHTML = '<tr><td colspan="4">No se encontraron usuarios.</td></tr>';
                    }
                }).withFailureHandler(error => {
                    hideLoading('users-loading');
                    console.error('Error al cargar usuarios:', error);
                    document.getElementById('users-table-body').innerHTML = `<tr><td colspan="4" class="message error">Error al cargar usuarios: ${error.message}</td></tr>`;
                }).getAllUsers();
            } catch (error) {
                hideLoading('users-loading');
                console.error('Unexpected error in loadUsers:', error);
                document.getElementById('users-table-body').innerHTML = `<tr><td colspan="4" class="message error">Error inesperado: ${error.message}</td></tr>`;
            }
        }

        function openAddEditUserModal(user = null) {
            hideMessage('user-form-message');
            userForm.reset();
            if (user) {
                document.getElementById('user-modal-title').textContent = 'Editar Usuario';
                userIdInput.value = user.ID;
                userUsernameInput.value = user.username;
                userRoleSelect.value = user.role;
                userTutoraNameInput.value = user.tutoraName || '';
                userPasswordInput.removeAttribute('required'); // Password is optional on edit
            } else {
                document.getElementById('user-modal-title').textContent = 'Añadir Nuevo Usuario';
                userIdInput.value = '';
                userRoleSelect.value = 'administrador'; // Default to admin for new user
                userPasswordInput.setAttribute('required', 'required'); // Password is required for new user
            }
            toggleTutoraField(); // Adjust visibility based on role
            addEditUserModal.style.display = 'flex';
        }

        function closeAddEditUserModal() {
            addEditUserModal.style.display = 'none';
        }

        userForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            hideMessage('user-form-message');
            showLoading('add-edit-user-modal');

            const userData = {
                ID: userIdInput.value || generateUniqueId(),
                username: userUsernameInput.value,
                password: userPasswordInput.value, // Will be hashed on server if provided
                role: userRoleSelect.value,
                tutoraName: userTutoraNameInput.value || ''
            };

            try {
                const response = await fetch(`${APP_SCRIPT_URL}`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/x-www-form-urlencoded',
                    },
                    body: new URLSearchParams({
                        action: 'addOrUpdateUser',
                        userData: JSON.stringify(userData)
                    }).toString()
                });
                const data = await response.json();

                if (data.success) {
                    showMessage('user-form-message', data.message, 'success');
                    closeAddEditUserModal();
                    loadUsers(); // Recargar la tabla de usuarios
                } else {
                    showMessage('user-form-message', `Error: ${data.message}`, 'error');
                }
            } catch (error) {
                console.error("Error al guardar usuario:", error);
                showMessage('user-form-message', 'Error de conexión al servidor.', 'error');
            } finally {
                hideLoading('add-edit-user-modal');
            }
        });

        async function deleteUser(userId, username) {
            if (!confirm(`¿Estás seguro de que quieres eliminar al usuario ${username}?`)) {
                return;
            }

            try {
                const response = await fetch(`${APP_SCRIPT_URL}`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/x-www-form-urlencoded',
                    },
                    body: new URLSearchParams({
                        action: 'deleteUser',
                        userId: userId
                    }).toString()
                });
                const data = await response.json();

                if (data.success) {
                    alert(data.message);
                    loadUsers();
                } else {
                    alert(`Error al eliminar usuario: ${data.message}`);
                }
            } catch (error) {
                console.error("Error al eliminar usuario:", error);
                alert('Error de conexión al servidor al intentar eliminar el usuario.');
            }
        }


        // --- Initial Load Logic ---
        document.addEventListener('DOMContentLoaded', () => {
            document.getElementById('fecha-registro').value = getCurrentDateISO();

            // Check URL for public access
            const urlParams = new URLSearchParams(window.location.search);
            const publicParticipantId = urlParams.get('id');
            const action = urlParams.get('action');

            if (action === 'getPublicParticipantData' && publicParticipantId) {
                loginModule.classList.add('hidden');
                mainApp.classList.add('hidden');
                tutoraPaymentView.classList.add('hidden'); // Ensure tutora view is also hidden
                publicParticipantView.classList.remove('hidden');
                loadPublicParticipantData(publicParticipantId);
            } else {
                loginModule.classList.remove('hidden');
                mainApp.classList.add('hidden');
                tutoraPaymentView.classList.add('hidden'); // Ensure tutora view is initially hidden
                publicParticipantView.classList.add('hidden');
            }
        });

    </script>
</body>
</html>
