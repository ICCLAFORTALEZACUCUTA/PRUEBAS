<!DOCTYPE html>
<html lang="es">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Sistema de Aportes ONG</title>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/tailwindcss/2.2.19/tailwind.min.css" rel="stylesheet">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/3.9.1/chart.min.js"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <style>
        * {
            box-sizing: border-box;
        }

        body {
            margin: 0;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }

        .gradient-bg {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        }

        .card-hover {
            transition: all 0.3s ease;
        }

        .card-hover:hover {
            transform: translateY(-5px);
            box-shadow: 0 10px 25px rgba(0, 0, 0, 0.2);
        }

        .sidebar {
            transition: transform 0.3s ease;
        }

        .sidebar-closed {
            transform: translateX(-100%);
        }
    </style>
</head>

<body class="bg-gray-100 flex h-screen">

    <aside id="sidebar" class="bg-gray-800 text-white w-64 space-y-6 py-7 px-2 absolute inset-y-0 left-0 transform md:relative md:translate-x-0 transition duration-200 ease-in-out sidebar-closed z-50">
        <button id="closeSidebar" class="absolute top-4 right-4 text-white md:hidden">
            <i class="fas fa-times text-2xl"></i>
        </button>
        <a href="#" class="text-white flex items-center space-x-2 px-4">
            <i class="fas fa-hand-holding-heart text-2xl"></i>
            <span class="text-2xl font-extrabold">ONG Aportes</span>
        </a>

        <nav>
            <a href="#" id="linkDashboard" class="block py-2.5 px-4 rounded transition duration-200 hover:bg-gray-700 active-link"><i class="fas fa-home mr-3"></i>Dashboard</a>
            <a href="#" id="linkParticipantes" class="block py-2.5 px-4 rounded transition duration-200 hover:bg-gray-700"><i class="fas fa-users mr-3"></i>Participantes</a>
            <a href="#" id="linkAportes" class="block py-2.5 px-4 rounded transition duration-200 hover:bg-gray-700"><i class="fas fa-coins mr-3"></i>Aportes</a>
            <a href="#" id="linkReportes" class="block py-2.5 px-4 rounded transition duration-200 hover:bg-gray-700"><i class="fas fa-chart-line mr-3"></i>Reportes</a>
        </nav>
        <div class="absolute bottom-0 w-full p-4">
            <a href="#" id="logoutButton" class="block py-2.5 px-4 rounded transition duration-200 hover:bg-red-700 bg-red-600 text-center"><i class="fas fa-sign-out-alt mr-3"></i>Cerrar Sesión</a>
        </div>
    </aside>

    <div class="flex-1 flex flex-col overflow-hidden">
        <header class="flex justify-between items-center p-4 bg-white shadow-md">
            <button id="openSidebar" class="text-gray-600 md:hidden">
                <i class="fas fa-bars text-2xl"></i>
            </button>
            <h1 class="text-xl font-semibold text-gray-800">Panel de Administración</h1>
            <div class="flex items-center space-x-4">
                <span id="loggedInUser" class="text-gray-700 font-medium"></span>
                <i class="fas fa-user-circle text-2xl text-gray-500"></i>
            </div>
        </header>

        <main class="flex-1 overflow-x-hidden overflow-y-auto bg-gray-100 p-6">
            <div id="content" class="container mx-auto">
                </div>
        </main>
    </div>

    <div id="loginModal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50">
        <div class="bg-white p-8 rounded-lg shadow-xl w-96">
            <h2 class="text-2xl font-bold text-center mb-6">Iniciar Sesión</h2>
            <form id="loginForm" class="space-y-4">
                <div>
                    <label for="username" class="block text-gray-700 text-sm font-bold mb-2">Usuario:</label>
                    <input type="text" id="username" name="username" class="shadow appearance-none border rounded w-full py-2 px-3 text-gray-700 leading-tight focus:outline-none focus:shadow-outline" required>
                </div>
                <div>
                    <label for="password" class="block text-gray-700 text-sm font-bold mb-2">Contraseña:</label>
                    <input type="password" id="password" name="password" class="shadow appearance-none border rounded w-full py-2 px-3 text-gray-700 mb-3 leading-tight focus:outline-none focus:shadow-outline" required>
                </div>
                <div id="loginError" class="text-red-500 text-xs italic mb-4 hidden"></div>
                <button type="submit" class="gradient-bg text-white font-bold py-2 px-4 rounded focus:outline-none focus:shadow-outline w-full hover:opacity-90 transition-opacity">Entrar</button>
            </form>
        </div>
    </div>

    <div id="participantModal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 hidden">
        <div class="bg-white p-8 rounded-lg shadow-xl w-full max-w-md">
            <h2 id="participantModalTitle" class="text-2xl font-bold text-center mb-6">Registrar Participante</h2>
            <form id="participantForm" class="space-y-4">
                <input type="hidden" id="originalCodigo">
                <div>
                    <label for="p-codigo" class="block text-gray-700 text-sm font-bold mb-2">Código:</label>
                    <input type="text" id="p-codigo" name="codigo" class="shadow appearance-none border rounded w-full py-2 px-3 text-gray-700 leading-tight focus:outline-none focus:shadow-outline" required>
                </div>
                <div>
                    <label for="p-nombre" class="block text-gray-700 text-sm font-bold mb-2">Nombre:</label>
                    <input type="text" id="p-nombre" name="nombre" class="shadow appearance-none border rounded w-full py-2 px-3 text-gray-700 leading-tight focus:outline-none focus:shadow-outline" required>
                </div>
                <div>
                    <label for="p-ciudadania" class="block text-gray-700 text-sm font-bold mb-2">Ciudadanía:</label>
                    <input type="text" id="p-ciudadania" name="ciudadania" class="shadow appearance-none border rounded w-full py-2 px-3 text-gray-700 leading-tight focus:outline-none focus:shadow-outline" required>
                </div>
                <div>
                    <label for="p-tutora" class="block text-gray-700 text-sm font-bold mb-2">Tutora (Correo):</label>
                    <input type="email" id="p-tutora" name="tutora" class="shadow appearance-none border rounded w-full py-2 px-3 text-gray-700 leading-tight focus:outline-none focus:shadow-outline" required>
                </div>
                <div id="participantError" class="text-red-500 text-xs italic mb-4 hidden"></div>
                <div class="flex justify-end space-x-4">
                    <button type="button" id="cancelParticipant" class="bg-gray-300 text-gray-800 font-bold py-2 px-4 rounded hover:bg-gray-400 focus:outline-none focus:shadow-outline">Cancelar</button>
                    <button type="submit" class="gradient-bg text-white font-bold py-2 px-4 rounded focus:outline-none focus:shadow-outline hover:opacity-90 transition-opacity">Guardar</button>
                </div>
            </form>
        </div>
    </div>

    <div id="aporteModal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 hidden">
        <div class="bg-white p-8 rounded-lg shadow-xl w-full max-w-md">
            <h2 class="text-2xl font-bold text-center mb-6">Registrar Aporte</h2>
            <form id="aporteForm" class="space-y-4">
                <div>
                    <label for="a-codigo" class="block text-gray-700 text-sm font-bold mb-2">Código Participante:</label>
                    <input type="text" id="a-codigo" name="codigo" class="shadow appearance-none border rounded w-full py-2 px-3 text-gray-700 leading-tight focus:outline-none focus:shadow-outline" required>
                </div>
                <div>
                    <label for="a-nombre-participante" class="block text-gray-700 text-sm font-bold mb-2">Nombre Participante:</label>
                    <input type="text" id="a-nombre-participante" name="nombreParticipante" class="shadow appearance-none border rounded w-full py-2 px-3 text-gray-700 leading-tight focus:outline-none focus:shadow-outline" readonly>
                </div>
                <div>
                    <label for="a-monto" class="block text-gray-700 text-sm font-bold mb-2">Monto ($):</label>
                    <input type="number" id="a-monto" name="monto" class="shadow appearance-none border rounded w-full py-2 px-3 text-gray-700 leading-tight focus:outline-none focus:shadow-outline" step="0.01" required>
                </div>
                <div>
                    <label for="a-fecha" class="block text-gray-700 text-sm font-bold mb-2">Fecha:</label>
                    <input type="date" id="a-fecha" name="fecha" class="shadow appearance-none border rounded w-full py-2 px-3 text-gray-700 leading-tight focus:outline-none focus:shadow-outline" required>
                </div>
                <div>
                    <label for="a-meses" class="block text-gray-700 text-sm font-bold mb-2">Mes(es) que cubre:</label>
                    <select id="a-meses" name="meses" class="shadow border rounded w-full py-2 px-3 text-gray-700 leading-tight focus:outline-none focus:shadow-outline" multiple required>
                        </select>
                    <p class="text-xs text-gray-500 mt-1">Mantén Ctrl/Cmd para seleccionar múltiples meses.</p>
                </div>
                <div id="aporteError" class="text-red-500 text-xs italic mb-4 hidden"></div>
                <div class="flex justify-end space-x-4">
                    <button type="button" id="cancelAporte" class="bg-gray-300 text-gray-800 font-bold py-2 px-4 rounded hover:bg-gray-400 focus:outline-none focus:shadow-outline">Cancelar</button>
                    <button type="submit" class="gradient-bg text-white font-bold py-2 px-4 rounded focus:outline-none focus:shadow-outline hover:opacity-90 transition-opacity">Registrar</button>
                </div>
            </form>
        </div>
    </div>


    <script>
        // =========================================================
        // === IMPORTANTE: CONFIGURACIÓN DE LA URL DE TU APPS SCRIPT ===
        // =========================================================
        // ¡DEBES REEMPLAZAR ESTA URL CON LA URL DE DESPLIEGUE DE TU APPS SCRIPT!
        // Ve a tu proyecto de Apps Script -> Desplegar -> Nueva implementación -> Tipo: Aplicación web
        // Copia la URL que termina en "/exec".
        const APPS_SCRIPT_URL = 'https://script.google.com/macros/s/AKfycbxdxcWFsOcZ5ED9uIPbiDUnYan61x9AgbaWb1FHeqTM5urDZbaxuIxXJKUXtI8y9vGZ/exec'; // <--- ¡CAMBIA ESTO!
        // =========================================================

        let currentUser = null; // Variable global para el usuario logueado

        // Función para realizar llamadas a Apps Script mediante Fetch API
        async function callAppsScript(action, data = {}) {
            try {
                const response = await fetch(APPS_SCRIPT_URL, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json', // Indicamos que enviamos JSON
                    },
                    body: JSON.stringify({ // Enviamos la acción y los datos como un objeto JSON
                        action: action,
                        data: data
                    })
                });

                if (!response.ok) {
                    throw new Error(`Error HTTP! estado: ${response.status}`);
                }

                const result = await response.json();
                return result;

            } catch (error) {
                console.error('Error al llamar a Apps Script:', error);
                // Retornar un formato de error consistente
                return { success: false, message: 'Error de comunicación con el servidor: ' + error.message };
            }
        }


        // Funciones de control de UI y navegación
        function showContent(html) {
            document.getElementById('content').innerHTML = html;
        }

        function setActiveLink(linkId) {
            document.querySelectorAll('nav a').forEach(link => {
                link.classList.remove('active-link');
                link.classList.remove('bg-gray-700'); // Eliminar la clase hover que puede quedar
            });
            const activeLink = document.getElementById(linkId);
            if (activeLink) {
                activeLink.classList.add('active-link', 'bg-gray-700');
            }
        }

        function closeSidebar() {
            if (window.innerWidth < 768) {
                document.getElementById('sidebar').classList.add('sidebar-closed');
            }
        }


        // =========================================================
        // === VISTAS DE LA APLICACIÓN ===
        // =========================================================

        async function loadDashboard() {
            setActiveLink('linkDashboard');
            closeSidebar();
            try {
                const response = await callAppsScript('getDashboardData');
                if (response.success) {
                    const data = response.data;
                    const dashboardHtml = `
                        <h2 class="text-3xl font-bold text-gray-800 mb-6">Dashboard</h2>
                        <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6 mb-8">
                            <div class="bg-white p-6 rounded-lg shadow-md flex items-center justify-between card-hover">
                                <div>
                                    <h3 class="text-lg font-medium text-gray-600">Total Aportes</h3>
                                    <p class="text-3xl font-bold text-gray-900">$${data.totalAportes.toLocaleString('es-ES')}</p>
                                </div>
                                <i class="fas fa-money-bill-wave text-5xl text-blue-500 opacity-20"></i>
                            </div>
                            <div class="bg-white p-6 rounded-lg shadow-md flex items-center justify-between card-hover">
                                <div>
                                    <h3 class="text-lg font-medium text-gray-600">Participantes Activos</h3>
                                    <p class="text-3xl font-bold text-gray-900">${data.participantesActivos}</p>
                                </div>
                                <i class="fas fa-user-check text-5xl text-green-500 opacity-20"></i>
                            </div>
                            <div class="bg-white p-6 rounded-lg shadow-md flex items-center justify-between card-hover">
                                <div>
                                    <h3 class="text-lg font-medium text-gray-600">Total Pendiente</h3>
                                    <p class="text-3xl font-bold text-gray-900">$${data.totalPendiente.toLocaleString('es-ES')}</p>
                                </div>
                                <i class="fas fa-hand-holding-usd text-5xl text-red-500 opacity-20"></i>
                            </div>
                            <div class="bg-white p-6 rounded-lg shadow-md flex items-center justify-between card-hover">
                                <div>
                                    <h3 class="text-lg font-medium text-gray-600">Nuevos Aportes (Hoy)</h3>
                                    <p class="text-3xl font-bold text-gray-900">N/A</p>
                                </div>
                                <i class="fas fa-calendar-day text-5xl text-purple-500 opacity-20"></i>
                            </div>
                        </div>

                        <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
                            <div class="bg-white p-6 rounded-lg shadow-md">
                                <h3 class="text-xl font-semibold text-gray-800 mb-4">Aportes Mensuales</h3>
                                <canvas id="monthlyAportesChart"></canvas>
                            </div>

                            <div class="bg-white p-6 rounded-lg shadow-md">
                                <h3 class="text-xl font-semibold text-gray-800 mb-4">Últimos Aportes</h3>
                                <div class="overflow-x-auto">
                                    <table class="min-w-full bg-white">
                                        <thead>
                                            <tr>
                                                <th class="py-2 px-4 border-b text-left">Participante</th>
                                                <th class="py-2 px-4 border-b text-left">Monto</th>
                                                <th class="py-2 px-4 border-b text-left">Fecha</th>
                                                <th class="py-2 px-4 border-b text-left">Meses</th>
                                            </tr>
                                        </thead>
                                        <tbody>
                                            ${data.ultimosAportes.map(aporte => `
                                                <tr>
                                                    <td class="py-2 px-4 border-b">${aporte.participanteNombre}</td>
                                                    <td class="py-2 px-4 border-b">$${aporte.monto.toLocaleString('es-ES')}</td>
                                                    <td class="py-2 px-4 border-b">${new Date(aporte.fecha).toLocaleDateString('es-ES')}</td>
                                                    <td class="py-2 px-4 border-b">${aporte.meses.join(', ')}</td>
                                                </tr>
                                            `).join('')}
                                        </tbody>
                                    </table>
                                </div>
                            </div>
                        </div>
                    `;
                    showContent(dashboardHtml);
                    renderMonthlyAportesChart(data.aportesMensuales);

                } else {
                    showContent(`<p class="text-red-500">${response.message}</p>`);
                }
            } catch (error) {
                console.error('Error al cargar dashboard:', error);
                showContent('<p class="text-red-500">Error al cargar el dashboard.</p>');
            }
        }

        async function loadParticipantes() {
            setActiveLink('linkParticipantes');
            closeSidebar();
            try {
                const response = await callAppsScript('getParticipantes');
                if (response.success) {
                    let participantesHtml = `
                        <h2 class="text-3xl font-bold text-gray-800 mb-6">Gestión de Participantes</h2>
                        <div class="flex justify-end mb-4">
                            <button id="addParticipantBtn" class="gradient-bg text-white font-bold py-2 px-4 rounded hover:opacity-90 transition-opacity">
                                <i class="fas fa-plus mr-2"></i> Nuevo Participante
                            </button>
                        </div>
                        <div class="bg-white p-6 rounded-lg shadow-md overflow-x-auto">
                            <table class="min-w-full bg-white">
                                <thead>
                                    <tr>
                                        <th class="py-2 px-4 border-b text-left">Código</th>
                                        <th class="py-2 px-4 border-b text-left">Nombre</th>
                                        <th class="py-2 px-4 border-b text-left">Ciudadanía</th>
                                        <th class="py-2 px-4 border-b text-left">Tutora</th>
                                        <th class="py-2 px-4 border-b text-left">Estado</th>
                                        <th class="py-2 px-4 border-b text-left">Pendiente</th>
                                        <th class="py-2 px-4 border-b text-left">Acciones</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    ${response.data.map(p => `
                                        <tr class="hover:bg-gray-50">
                                            <td class="py-2 px-4 border-b">${p.codigo}</td>
                                            <td class="py-2 px-4 border-b">${p.nombre}</td>
                                            <td class="py-2 px-4 border-b">${p.ciudadania}</td>
                                            <td class="py-2 px-4 border-b">${p.tutora}</td>
                                            <td class="py-2 px-4 border-b">
                                                <span class="px-2 py-1 rounded-full text-xs font-semibold ${p.estado === 'Activo' ? 'bg-green-100 text-green-800' : 'bg-red-100 text-red-800'}">
                                                    ${p.estado}
                                                </span>
                                            </td>
                                            <td class="py-2 px-4 border-b">$${p.totalPendiente.toLocaleString('es-ES')} (${p.mesesPendientes.length} meses)</td>
                                            <td class="py-2 px-4 border-b">
                                                <button class="text-blue-600 hover:text-blue-900 mr-2 edit-participant-btn" data-codigo="${p.codigo}" data-nombre="${p.nombre}" data-ciudadania="${p.ciudadania}" data-tutora="${p.tutora}">
                                                    <i class="fas fa-edit"></i>
                                                </button>
                                                <button class="text-red-600 hover:text-red-900 delete-participant-btn" data-codigo="${p.codigo}">
                                                    <i class="fas fa-trash-alt"></i>
                                                </button>
                                                <button class="text-purple-600 hover:text-purple-900 ml-2 view-detail-btn" data-codigo="${p.codigo}">
                                                    <i class="fas fa-eye"></i>
                                                </button>
                                            </td>
                                        </tr>
                                    `).join('')}
                                </tbody>
                            </table>
                        </div>
                    `;
                    showContent(participantesHtml);
                    document.getElementById('addParticipantBtn').addEventListener('click', () => openParticipantModal('add'));
                    document.querySelectorAll('.edit-participant-btn').forEach(button => {
                        button.addEventListener('click', (e) => openParticipantModal('edit', e.currentTarget.dataset));
                    });
                    document.querySelectorAll('.delete-participant-btn').forEach(button => {
                        button.addEventListener('click', (e) => deleteParticipant(e.currentTarget.dataset.codigo));
                    });
                    document.querySelectorAll('.view-detail-btn').forEach(button => {
                        button.addEventListener('click', (e) => {
                            const codigo = e.currentTarget.dataset.codigo;
                            window.location.hash = `#participante=${codigo}`; // Change URL hash
                            loadParticipanteDetalle(codigo); // Load detail directly
                        });
                    });

                } else {
                    showContent(`<p class="text-red-500">${response.message}</p>`);
                }
            } catch (error) {
                console.error('Error al cargar participantes:', error);
                showContent('<p class="text-red-500">Error al cargar los participantes.</p>');
            }
        }


        async function loadAportes() {
            setActiveLink('linkAportes');
            closeSidebar();
            try {
                const response = await callAppsScript('getAportes');
                if (response.success) {
                    const aportesHtml = `
                        <h2 class="text-3xl font-bold text-gray-800 mb-6">Gestión de Aportes</h2>
                        <div class="flex justify-end mb-4">
                            <button id="addAporteBtn" class="gradient-bg text-white font-bold py-2 px-4 rounded hover:opacity-90 transition-opacity">
                                <i class="fas fa-plus mr-2"></i> Registrar Aporte
                            </button>
                        </div>
                        <div class="bg-white p-6 rounded-lg shadow-md overflow-x-auto">
                            <table class="min-w-full bg-white">
                                <thead>
                                    <tr>
                                        <th class="py-2 px-4 border-b text-left">ID</th>
                                        <th class="py-2 px-4 border-b text-left">Código</th>
                                        <th class="py-2 px-4 border-b text-left">Participante</th>
                                        <th class="py-2 px-4 border-b text-left">Mes(es)</th>
                                        <th class="py-2 px-4 border-b text-left">Monto</th>
                                        <th class="py-2 px-4 border-b text-left">Fecha</th>
                                        <th class="py-2 px-4 border-b text-left">Tutora</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    ${response.data.map(a => `
                                        <tr class="hover:bg-gray-50">
                                            <td class="py-2 px-4 border-b">${a.id}</td>
                                            <td class="py-2 px-4 border-b">${a.participanteCodigo}</td>
                                            <td class="py-2 px-4 border-b">${a.participanteNombre}</td>
                                            <td class="py-2 px-4 border-b">${a.meses.join(', ')}</td>
                                            <td class="py-2 px-4 border-b">$${a.total.toLocaleString('es-ES')}</td>
                                            <td class="py-2 px-4 border-b">${a.fecha ? new Date(a.fecha).toLocaleDateString('es-ES') : 'N/A'}</td>
                                            <td class="py-2 px-4 border-b">${a.tutora}</td>
                                        </tr>
                                    `).join('')}
                                </tbody>
                            </table>
                        </div>
                    `;
                    showContent(aportesHtml);
                    document.getElementById('addAporteBtn').addEventListener('click', openAporteModal);
                } else {
                    showContent(`<p class="text-red-500">${response.message}</p>`);
                }
            } catch (error) {
                console.error('Error al cargar aportes:', error);
                showContent('<p class="text-red-500">Error al cargar los aportes.</p>');
            }
        }


        async function loadReportes() {
            setActiveLink('linkReportes');
            closeSidebar();
            // Esto es un placeholder. Aquí integrarías tu lógica de reportes.
            showContent(`
                <h2 class="text-3xl font-bold text-gray-800 mb-6">Generación de Reportes</h2>
                <div class="bg-white p-6 rounded-lg shadow-md">
                    <p>Aquí podrás generar diversos reportes sobre participantes y aportes.</p>
                    <p class="mt-4 text-gray-600">Funcionalidad en desarrollo...</p>
                </div>
            `);
        }

        async function loadParticipanteDetalle(codigo) {
            closeSidebar();
            try {
                const response = await callAppsScript('getParticipanteDetalle', { codigo: codigo });
                if (response.success) {
                    const participante = response.data;
                    let detailHtml = `
                        <h2 class="text-3xl font-bold text-gray-800 mb-6">Detalle de Participante</h2>
                        <button onclick="window.history.back()" class="text-blue-600 hover:text-blue-800 mb-4"><i class="fas fa-arrow-left mr-2"></i> Volver a Participantes</button>
                        <div class="bg-white p-6 rounded-lg shadow-md">
                            <h3 class="text-2xl font-bold mb-4">${participante.nombre} (${participante.codigo})</h3>
                            <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-6">
                                <p><span class="font-medium">Ciudadanía:</span> ${participante.ciudadania}</p>
                                <p><span class="font-medium">Tutora:</span> ${participante.tutora}</p>
                                <p><span class="font-medium">Fecha Registro:</span> ${participante.fecharegistro}</p>
                                <p><span class="font-medium">Estado:</span> <span class="px-2 py-1 rounded-full text-xs font-semibold ${participante.estado === 'Activo' ? 'bg-green-100 text-green-800' : 'bg-red-100 text-red-800'}">${participante.estado}</span></p>
                                <p><span class="font-medium">Último Pago:</span> ${participante.ultimoPago}</p>
                                <p><span class="font-medium">Total Pendiente:</span> $${participante.totalPendiente.toLocaleString('es-ES')}</p>
                            </div>

                            <h4 class="text-xl font-semibold text-gray-800 mb-3">Matriz de Pagos Anual</h4>
                            <div class="overflow-x-auto mb-6">
                                <table class="min-w-full bg-white border border-gray-200">
                                    <thead>
                                        <tr class="bg-gray-100">
                                            <th class="py-2 px-4 border-b border-r text-left">Mes</th>
                                            <th class="py-2 px-4 border-b border-r text-left">Año</th>
                                            <th class="py-2 px-4 border-b border-r text-left">Estado</th>
                                            <th class="py-2 px-4 border-b text-left">Monto Pagado</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        ${participante.matrizPagos.map(item => `
                                            <tr class="${item.estado === 'Pagado' ? 'bg-green-50' : 'bg-red-50'} hover:bg-gray-100">
                                                <td class="py-2 px-4 border-b border-r">${item.mes}</td>
                                                <td class="py-2 px-4 border-b border-r">${item.año}</td>
                                                <td class="py-2 px-4 border-b border-r">${item.estado}</td>
                                                <td class="py-2 px-4 border-b">$${item.montoPagado.toLocaleString('es-ES')}</td>
                                            </tr>
                                        `).join('')}
                                    </tbody>
                                </table>
                            </div>
                            
                            <h4 class="text-xl font-semibold text-gray-800 mb-3">Historial de Aportes</h4>
                            <div class="overflow-x-auto">
                                <table class="min-w-full bg-white border border-gray-200">
                                    <thead>
                                        <tr class="bg-gray-100">
                                            <th class="py-2 px-4 border-b text-left">ID Aporte</th>
                                            <th class="py-2 px-4 border-b text-left">Mes(es)</th>
                                            <th class="py-2 px-4 border-b text-left">Monto Total</th>
                                            <th class="py-2 px-4 border-b text-left">Fecha Aporte</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        ${participante.aportes.map(aporte => `
                                            <tr class="hover:bg-gray-50">
                                                <td class="py-2 px-4 border-b">${aporte.id}</td>
                                                <td class="py-2 px-4 border-b">${aporte.meses.join(', ')}</td>
                                                <td class="py-2 px-4 border-b">$${aporte.total.toLocaleString('es-ES')}</td>
                                                <td class="py-2 px-4 border-b">${new Date(aporte.fecha).toLocaleDateString('es-ES')}</td>
                                            </tr>
                                        `).join('')}
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    `;
                    showContent(detailHtml);
                } else {
                    showContent(`<p class="text-red-500">${response.message}</p>`);
                }
            } catch (error) {
                console.error('Error al cargar detalle del participante:', error);
                showContent('<p class="text-red-500">Error al cargar el detalle del participante.</p>');
            }
        }


        // =========================================================
        // === MODALES Y FORMULARIOS ===
        // =========================================================

        function openParticipantModal(mode, data = {}) {
            const modal = document.getElementById('participantModal');
            const form = document.getElementById('participantForm');
            const title = document.getElementById('participantModalTitle');
            const submitBtn = form.querySelector('button[type="submit"]');
            const errorDiv = document.getElementById('participantError');

            errorDiv.classList.add('hidden'); // Ocultar errores previos
            form.reset(); // Limpiar formulario

            if (mode === 'add') {
                title.textContent = 'Registrar Participante';
                submitBtn.textContent = 'Guardar';
                document.getElementById('originalCodigo').value = '';
                document.getElementById('p-codigo').readOnly = false;
            } else { // mode === 'edit'
                title.textContent = 'Modificar Participante';
                submitBtn.textContent = 'Actualizar';
                document.getElementById('originalCodigo').value = data.codigo;
                document.getElementById('p-codigo').value = data.codigo;
                document.getElementById('p-nombre').value = data.nombre;
                document.getElementById('p-ciudadania').value = data.ciudadania;
                document.getElementById('p-tutora').value = data.tutora;
                document.getElementById('p-codigo').readOnly = false; // Permitir editar código si es necesario
            }
            modal.classList.remove('hidden');
        }

        function closeParticipantModal() {
            document.getElementById('participantModal').classList.add('hidden');
        }

        document.getElementById('participantForm').addEventListener('submit', async function (e) {
            e.preventDefault();
            const originalCodigo = document.getElementById('originalCodigo').value;
            const formData = {
                codigo: document.getElementById('p-codigo').value,
                nombre: document.getElementById('p-nombre').value,
                ciudadania: document.getElementById('p-ciudadania').value,
                tutora: document.getElementById('p-tutora').value,
            };

            const errorDiv = document.getElementById('participantError');
            errorDiv.classList.add('hidden');

            try {
                let response;
                if (originalCodigo) { // Editing existing participant
                    response = await callAppsScript('modificarParticipante', { ...formData, originalCodigo: originalCodigo });
                } else { // Adding new participant
                    response = await callAppsScript('registrarParticipante', formData);
                }

                if (response.success) {
                    closeParticipantModal();
                    loadParticipantes(); // Recargar la tabla de participantes
                    alert(response.message);
                } else {
                    errorDiv.textContent = response.message;
                    errorDiv.classList.remove('hidden');
                }
            } catch (error) {
                console.error('Error en formulario de participante:', error);
                errorDiv.textContent = 'Ocurrió un error inesperado al guardar.';
                errorDiv.classList.remove('hidden');
            }
        });

        document.getElementById('cancelParticipant').addEventListener('click', closeParticipantModal);

        async function deleteParticipant(codigo) {
            if (confirm(`¿Estás seguro de eliminar al participante con código ${codigo}? Esta acción es irreversible.`)) {
                try {
                    const response = await callAppsScript('eliminarParticipante', { codigo: codigo });
                    if (response.success) {
                        loadParticipantes(); // Recargar la tabla
                        alert(response.message);
                    } else {
                        alert(`Error: ${response.message}`);
                    }
                } catch (error) {
                    console.error('Error al eliminar participante:', error);
                    alert('Ocurrió un error inesperado al eliminar el participante.');
                }
            }
        }


        async function openAporteModal() {
            const modal = document.getElementById('aporteModal');
            const form = document.getElementById('aporteForm');
            const errorDiv = document.getElementById('aporteError');
            const mesesSelect = document.getElementById('a-meses');

            errorDiv.classList.add('hidden');
            form.reset();
            mesesSelect.innerHTML = '<option value="">Cargando...</option>'; // Placeholder

            // Set default date to today
            const today = new Date();
            const yyyy = today.getFullYear();
            const mm = String(today.getMonth() + 1).padStart(2, '0'); // Months are 0-indexed
            const dd = String(today.getDate()).padStart(2, '0');
            document.getElementById('a-fecha').value = `${yyyy}-${mm}-${dd}`;


            modal.classList.remove('hidden');

            // Autocompletar nombre del participante y cargar meses disponibles al escribir el código
            document.getElementById('a-codigo').addEventListener('input', async function () {
                const codigo = this.value;
                const nombreInput = document.getElementById('a-nombre-participante');
                mesesSelect.innerHTML = ''; // Clear previous options

                if (codigo.length > 0) {
                    const response = await callAppsScript('getParticipanteDetalle', { codigo: codigo });
                    if (response.success && response.data) {
                        nombreInput.value = response.data.nombre;
                        const mesesDisponibles = response.data.mesesPendientes;
                        if (mesesDisponibles.length > 0) {
                            mesesDisponibles.forEach(mes => {
                                const option = document.createElement('option');
                                option.value = mes;
                                option.textContent = mes;
                                mesesSelect.appendChild(option);
                            });
                        } else {
                            mesesSelect.innerHTML = '<option value="">Todos los meses pagados o no disponibles</option>';
                        }
                    } else {
                        nombreInput.value = 'Participante no encontrado';
                        mesesSelect.innerHTML = '<option value="">No disponible</option>';
                    }
                } else {
                    nombreInput.value = '';
                    mesesSelect.innerHTML = '';
                }
            }, { once: false }); // Allow multiple inputs

            // Populate months initially if a code is pre-filled (e.g., from a URL param) - unlikely for this modal
            // but good practice.
            // For now, it relies on the 'input' event.
        }

        function closeAporteModal() {
            document.getElementById('aporteModal').classList.add('hidden');
            // Remove event listener to prevent multiple bindings on subsequent opens
            document.getElementById('a-codigo').removeEventListener('input', () => {});
        }

        document.getElementById('aporteForm').addEventListener('submit', async function (e) {
            e.preventDefault();
            const errorDiv = document.getElementById('aporteError');
            errorDiv.classList.add('hidden');

            const selectedMonths = Array.from(document.getElementById('a-meses').selectedOptions).map(option => option.value);

            const formData = {
                codigo: document.getElementById('a-codigo').value,
                monto: parseFloat(document.getElementById('a-monto').value),
                fecha: document.getElementById('a-fecha').value,
                meses: selectedMonths,
            };

            if (selectedMonths.length === 0) {
                errorDiv.textContent = 'Debes seleccionar al menos un mes para el aporte.';
                errorDiv.classList.remove('hidden');
                return;
            }

            try {
                const response = await callAppsScript('registrarAporte', formData);
                if (response.success) {
                    closeAporteModal();
                    loadAportes(); // Recargar la tabla de aportes
                    alert(response.message);
                } else {
                    errorDiv.textContent = response.message;
                    errorDiv.classList.remove('hidden');
                }
            } catch (error) {
                console.error('Error en formulario de aporte:', error);
                errorDiv.textContent = 'Ocurrió un error inesperado al registrar el aporte.';
                errorDiv.classList.remove('hidden');
            }
        });

        document.getElementById('cancelAporte').addEventListener('click', closeAporteModal);


        // =========================================================
        // === GRÁFICOS ===
        // =========================================================

        let monthlyAportesChart = null; // Variable para mantener la instancia del gráfico

        function renderMonthlyAportesChart(data) {
            const ctx = document.getElementById('monthlyAportesChart').getContext('2d');

            const labels = Object.keys(data).sort(); // Ordenar por año-mes
            const values = labels.map(key => data[key]);

            if (monthlyAportesChart) {
                monthlyAportesChart.destroy(); // Destruir instancia anterior si existe
            }

            monthlyAportesChart = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: labels,
                    datasets: [{
                        label: 'Aportes Mensuales ($)',
                        data: values,
                        backgroundColor: 'rgba(102, 126, 234, 0.7)',
                        borderColor: 'rgba(102, 126, 234, 1)',
                        borderWidth: 1
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    scales: {
                        y: {
                            beginAtZero: true,
                            title: {
                                display: true,
                                text: 'Monto ($)'
                            }
                        },
                        x: {
                            title: {
                                display: true,
                                text: 'Mes'
                            }
                        }
                    },
                    plugins: {
                        tooltip: {
                            callbacks: {
                                label: function(context) {
                                    return context.dataset.label + ': $' + context.parsed.y.toLocaleString('es-ES');
                                }
                            }
                        }
                    }
                }
            });
        }


        // =========================================================
        // === AUTENTICACIÓN Y ESTADO DE LA SESIÓN ===
        // =========================================================

        function checkLoginStatus() {
            const storedUser = localStorage.getItem('currentUser');
            if (storedUser) {
                currentUser = JSON.parse(storedUser);
                document.getElementById('loginModal').classList.add('hidden');
                document.getElementById('loggedInUser').textContent = `Hola, ${currentUser.usuario}`;
                loadDashboard(); // Cargar dashboard después de login
            } else {
                document.getElementById('loginModal').classList.remove('hidden');
            }
        }

        document.getElementById('loginForm').addEventListener('submit', async function (e) {
            e.preventDefault();
            const username = document.getElementById('username').value;
            const password = document.getElementById('password').value;
            const loginErrorDiv = document.getElementById('loginError');
            loginErrorDiv.classList.add('hidden'); // Ocultar errores previos

            try {
                const response = await callAppsScript('login', { usuario: username, password: password });
                if (response.success) {
                    currentUser = response.user;
                    localStorage.setItem('currentUser', JSON.stringify(currentUser));
                    document.getElementById('loginModal').classList.add('hidden');
                    document.getElementById('loggedInUser').textContent = `Hola, ${currentUser.usuario}`;
                    loadDashboard(); // Cargar dashboard después del login exitoso
                } else {
                    loginErrorDiv.textContent = response.message;
                    loginErrorDiv.classList.remove('hidden');
                }
            } catch (error) {
                console.error('Error durante el login:', error);
                loginErrorDiv.textContent = 'Error de red o servidor. Intenta de nuevo.';
                loginErrorDiv.classList.remove('hidden');
            }
        });

        document.getElementById('logoutButton').addEventListener('click', function (e) {
            e.preventDefault();
            localStorage.removeItem('currentUser');
            currentUser = null;
            document.getElementById('loggedInUser').textContent = '';
            checkLoginStatus(); // Volver a mostrar el modal de login
        });


        // =========================================================
        // === EVENT LISTENERS Y CARGA INICIAL ===
        // =========================================================

        document.getElementById('linkDashboard').addEventListener('click', (e) => { e.preventDefault(); loadDashboard(); });
        document.getElementById('linkParticipantes').addEventListener('click', (e) => { e.preventDefault(); loadParticipantes(); });
        document.getElementById('linkAportes').addEventListener('click', (e) => { e.preventDefault(); loadAportes(); });
        document.getElementById('linkReportes').addEventListener('click', (e) => { e.preventDefault(); loadReportes(); });


        // Manejar apertura/cierre de sidebar
        document.getElementById('openSidebar').addEventListener('click', () => {
            document.getElementById('sidebar').classList.remove('sidebar-closed');
        });
        document.getElementById('closeSidebar').addEventListener('click', () => {
            document.getElementById('sidebar').classList.add('sidebar-closed');
        });


        // Verificar si hay parámetro de URL al cargar para vista pública de participante
        async function checkURLParams() {
            const params = new URLSearchParams(window.location.hash.substring(1)); // Get hash part
            const participanteCodigo = params.get('participante');
            if (participanteCodigo) {
                // If a participant code is in the URL, try to load its details directly
                document.getElementById('loginModal').classList.add('hidden'); // Hide login if directly viewing a participant
                await loadParticipanteDetalle(participanteCodigo);
            } else {
                // Otherwise, proceed with normal login check
                checkLoginStatus();
            }
        }

        // Verificar parámetros de URL al cargar
        window.addEventListener('load', checkURLParams);

        // Responsive sidebar
        window.addEventListener('resize', function () {
            const sidebar = document.getElementById('sidebar');
            if (window.innerWidth >= 768) {
                sidebar.classList.remove('sidebar-closed');
            } else {
                sidebar.classList.add('sidebar-closed');
            }
        });

    </script>
</body>

</html>
